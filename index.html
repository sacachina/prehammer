<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ä½³å£«å¾—ç´ç´„ä¸‰æœˆã€ŒMax N. Berryã€å°ˆå ´ï½œå”ä¸‰å½©æ‹å‰å…±è­˜ï¼ˆå…§éƒ¨å…§æ¸¬ï¼‰</title>
  <style>
    :root{
      --text:#111;
      --muted:#666;
      --line:#e6e6e6;
      --bg:#fafafa;
      --card:#fff;
      --ok:#0a7f2e;
      --warn:#b00020;
    }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"PingFang TC","Noto Sans TC","Microsoft JhengHei",system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      line-height:1.55;
    }
    .wrap{ max-width:980px; margin:0 auto; padding:28px 18px 44px; }
    header{ margin-bottom:18px; }
    h1{ font-size:26px; margin:0 0 6px 0; letter-spacing:.2px; }
    .sub{ margin:0; color:var(--muted); font-size:14px; }

    .topRow{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:10px; }
    .badge{
      font-size:12px; color:#111; border:1px solid var(--line); background:#fff;
      border-radius:999px; padding:7px 10px; display:inline-flex; align-items:center; gap:8px;
    }
    .dot{ width:7px; height:7px; border-radius:50%; background:#111; animation:pulse 1.2s infinite; }
    @keyframes pulse{ 0%{transform:scale(1);opacity:.35} 50%{transform:scale(1.35);opacity:.9} 100%{transform:scale(1);opacity:.35} }

    .grid{ display:grid; grid-template-columns:1fr; gap:16px; margin-top:18px; }
    @media (min-width: 900px){ .grid{ grid-template-columns:1fr 1fr; } }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 2px 10px rgba(0,0,0,.04);
      display:flex;
      flex-direction:column;
    }

    .imgBox{ width:100%; height:420px; background:#f0f0f0; overflow:hidden; }
    @media (min-width: 900px){ .imgBox{ height:460px; } }
    .imgBox img{ width:100%; height:100%; object-fit:cover; object-position:center 35%; display:block; }

    .content{ padding:16px 16px 14px; }
    .title{ font-size:18px; margin:0 0 8px 0; letter-spacing:.2px; }
    .meta{ font-size:13px; color:var(--muted); margin:0 0 12px 0; }
    .meta b{ color:var(--text); font-weight:600; }

    .pillRow{ display:flex; flex-wrap:wrap; gap:8px; margin:10px 0; }
    .pill{ font-size:12px; border:1px solid var(--line); border-radius:999px; padding:6px 10px; background:#fff; }

    .voteBox{ border-top:1px solid var(--line); padding:12px 16px 14px; }
    .voteTitle{ font-size:13px; margin:0 0 10px 0; font-weight:600; }

    .btn{
      width:100%;
      padding:11px 12px;
      border-radius:10px;
      border:1px solid #111;
      background:#fff;
      color:#111;
      font-size:14px;
      cursor:pointer;
      margin:7px 0;
      transition:transform .05s ease, background .12s ease, opacity .12s ease;
    }
    .btn.primary{ background:#111; color:#fff; }
    .btn:active{ transform:translateY(1px); }
    .btn[disabled]{ cursor:not-allowed; opacity:.45; }

    .result{
      margin-top:10px;
      font-size:13px;
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px;
      background:#fcfcfc;
      display:none;
      animation:pop .18s ease-out;
    }
    @keyframes pop{ from{ transform:translateY(6px); opacity:0; } to{ transform:translateY(0); opacity:1; } }

    .bar{ height:8px; background:#eee; border-radius:999px; overflow:hidden; margin:6px 0 10px; }
    .bar > div{ height:100%; background:#111; width:0%; transition:width .25s ease; }

    .rows{ margin-top:8px; }
    .row{
      display:grid;
      grid-template-columns:1fr auto;
      gap:10px;
      padding:6px 0;
      border-top:1px dashed #eaeaea;
    }
    .row:first-child{ border-top:0; }
    .row b{ font-weight:600; }

    /* Name gating */
    .inlineRow{ display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 6px; }
    .input{
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px 10px;
      font-size:13px;
      background:#fff;
      outline:none;
      flex:1;
      min-width:220px;
    }
    .hint{ font-size:12px; color:var(--muted); margin:6px 0 0; }
    .warn{ color:var(--warn); font-size:12px; margin:8px 0 0; display:none; }

    /* Slider */
    .sliderWrap{
      border:1px solid #ececec;
      background:#fff;
      border-radius:12px;
      padding:10px 10px 12px;
      margin-top:10px;
    }
    .sliderHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .sliderTitle{ font-size:12px; font-weight:700; color:#111; }
    .sliderValue{ font-size:12px; color:var(--muted); }
    input[type="range"]{ width:100%; }
    .scale{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:11px;
      color:#888;
      margin-top:6px;
    }

    /* Chart hover tooltip */
    .chartWrap{ margin-top:10px; border-top:1px solid #e9e9e9; padding-top:10px; position:relative; }
    .chartHead{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px; }
    .chartTitle{ font-size:12px; color:#222; font-weight:600; display:flex; align-items:center; gap:6px; }
    .sparkLabel{ font-size:12px; color:var(--muted); white-space:nowrap; }
    canvas{ width:100%; height:120px; display:block; background:#fff; border:1px solid #eaeaea; border-radius:10px; }
    .tooltip{
      position:absolute;
      pointer-events:none;
      display:none;
      background:#111;
      color:#fff;
      font-size:12px;
      padding:7px 8px;
      border-radius:10px;
      white-space:nowrap;
      transform:translate(-50%, -115%);
      box-shadow:0 6px 16px rgba(0,0,0,.18);
    }
    .crosshair{
      position:absolute;
      top:44px;
      bottom:14px;
      width:1px;
      background:rgba(17,17,17,.25);
      display:none;
      pointer-events:none;
    }

    .small{ font-size:12px; color:var(--muted); margin-top:10px; }

    /* Panels */
    .panel{
      margin-top:16px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      box-shadow:0 2px 10px rgba(0,0,0,.04);
      padding:14px 14px 16px;
    }
    .panel h2{ font-size:15px; margin:0 0 10px 0; letter-spacing:.2px; }
    .panel .metaLine{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:8px 0 10px; }
    .chip{ font-size:12px; border:1px solid var(--line); border-radius:999px; padding:6px 10px; background:#fff; color:#111; display:inline-flex; align-items:center; gap:8px; }
    .statusDot{ width:7px; height:7px; border-radius:50%; background:var(--ok); animation:pulse 1.2s infinite; }
    .analysisBox{ border:1px solid #ececec; border-radius:12px; background:#fcfcfc; padding:12px 12px 10px; }
    .analysisTitle{ font-size:12px; font-weight:700; color:#111; margin:0 0 6px 0; display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .analysisBody{ font-size:13px; color:#222; margin:0; white-space:pre-line; }
    .analysisHint{ font-size:12px; color:var(--muted); margin-top:8px; }

    /* Comments */
    .commentForm{ display:grid; grid-template-columns: 180px 1fr auto; gap:10px; margin-top:10px; }
    @media (max-width: 720px){ .commentForm{ grid-template-columns: 1fr; } }
    select, textarea{
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px 10px;
      font-size:13px;
      background:#fff;
      outline:none;
    }
    textarea{ min-height:44px; resize:vertical; }
    .sendBtn{
      border:1px solid #111;
      background:#111;
      color:#fff;
      border-radius:10px;
      padding:10px 12px;
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
    }
    .sendBtn:active{ transform:translateY(1px); }
    .commentList{ margin-top:12px; border-top:1px solid #eee; padding-top:10px; display:flex; flex-direction:column; gap:10px; }
    .comment{ border:1px solid #efefef; background:#fff; border-radius:12px; padding:10px 10px; }
    .commentHead{ display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:6px; font-size:12px; color:var(--muted); }
    .commentHead b{ color:#111; font-weight:700; }
    .commentBody{ font-size:13px; color:#111; margin:0; white-space:pre-wrap; word-break:break-word; }
    .commentTools{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }

    footer{
      margin-top:18px;
      color:var(--muted);
      font-size:12px;
      border-top:1px solid var(--line);
      padding-top:14px;
    }
    .link{ color:#111; text-decoration:underline; text-underline-offset:2px; }
  </style>
</head>

<body>
<div class="wrap">

<header>
  <h1>ä½³å£«å¾—ç´ç´„ä¸‰æœˆã€ŒMax N. Berryã€å°ˆå ´ï½œå”ä¸‰å½©æ‹å‰å…±è­˜</h1>
  <p class="sub">å³æ™‚èšåˆæ‹å‰åˆ¤æ–·ï½œæ‹å¾Œ 24 å°æ™‚å…§å…¬é–‹å°ç…§çµæœï¼ˆå…§éƒ¨å…§æ¸¬é€šé“ï¼‰</p>
  <div class="topRow">
    <span class="badge"><span class="dot"></span><span id="countdown">æ‹è³£å€’æ•¸ï¼šè¨ˆç®—ä¸­â€¦</span></span>
    <span class="badge">å°ˆå ´ï¼šImportant Chinese Artï½œæ‹è³£æ—¥ï¼š2026-03-26ï¼ˆç´ç´„ï¼‰</span>
    <span class="badge">ç•¶å‰èº«ä»½ï¼š<b id="whoAmI">æœªè¨­å®šå§“å</b></span>
  </div>
</header>

<div class="grid">

  <!-- Lot 1 -->
  <article class="card" data-lot="lot1">
    <div class="imgBox">
      <img
        src="https://www.christies.com/-/jssmedia/images/features/articles/2025/in-the-frame/jon-gries/75023119_2400-dotcom-jpeg.jpg?mw=3200&mh=3200&hash=02b23de5c19c8eba206f7a5ebbe49091674eda5f"
        alt="å” ä¸‰å½©è—é‡‰èˆ‡ä¸‰å½©ä»•å¥³ä¿‘ä¸€å°"
        loading="lazy">
    </div>
    <div class="content">
      <h2 class="title">å” ä¸‰å½©è—é‡‰èˆ‡ä¸‰å½©ä»•å¥³ä¿‘ä¸€å°</h2>
      <p class="meta">
        <b>å”ä»£ï¼ˆ618â€“907ï¼‰</b>ï½œæœ€é«˜ 15 1/2 inï¼ˆç´„ 39.4 cmï¼‰ï½œComposite stand<br>
        ä¼°åƒ¹ï¼š<b>USD 50,000â€“80,000</b>ï½œChristieâ€™s New Yorkï½œ2026-03-26
      </p>
      <div class="pillRow">
        <span class="pill">ä»•å¥³ä¸€å°</span>
        <span class="pill">è—é‡‰ + ä¸‰å½©</span>
        <span class="pill">æ‹å‰å…±è­˜è¿½è¹¤</span>
      </div>
    </div>

    <div class="voteBox">
      <p class="voteTitle">ä½ çš„é æ¸¬ï¼ˆå…ˆè¼¸å…¥å§“åå¾Œæ‰å¯æŠ•ç¥¨ï¼‰</p>

      <div class="inlineRow">
        <input class="input" id="nameInput" type="text" placeholder="è¼¸å…¥ä½ çš„åå­—ï¼ˆä¾‹ï¼šAllen / å°æ— / Chenï¼‰" maxlength="30" oninput="saveNameFrom(1)">
      </div>

      <div class="warn" id="warn-lot1">è«‹å…ˆè¼¸å…¥åå­—ã€‚</div>
      <div class="warn" id="lock-lot1">ä½ å·²æŠ•éç¥¨ï¼ˆæœ¬æ‹å“åƒ…èƒ½æŠ•ä¸€æ¬¡ï¼‰ã€‚</div>

      <!-- åªä¿ç•™ï¼šæµæ‹ -->
      <button class="btn voteBtn" data-lot="lot1" onclick="voteBucket('lot1','æµæ‹')" disabled>æµæ‹</button>

      <!-- åªä¿ç•™ï¼šæ»‘å‹•æ¢ï¼ˆæœ€é«˜ 5,000,000ï¼‰ -->
      <div class="sliderWrap">
        <div class="sliderHead">
          <div class="sliderTitle">è‡ªå®šæˆäº¤åƒ¹ï¼ˆUSDï¼‰</div>
          <div class="sliderValue">ç›®æ¨™ï¼š<b id="sliderVal-lot1">100,000</b></div>
        </div>
        <input type="range" id="slider-lot1" min="50000" max="5000000" step="10000" value="100000" oninput="updateSlider('lot1')">
        <div class="scale">
          <span>50k</span><span>500k</span><span>2M</span><span>5M</span>
        </div>
        <button class="btn primary voteBtn" data-lot="lot1" onclick="votePrice('lot1')" disabled>æŠ•ç¥¨ï¼šä»¥ä¸Šç›®æ¨™åƒ¹æˆäº¤</button>
        <div class="hint">æç¤ºï¼šç”¨æ»‘æ¡¿èª¿æ•´ä½ çš„é æ¸¬æˆäº¤åƒ¹ï¼Œç„¶å¾ŒæŒ‰ä¸€æ¬¡æŠ•ç¥¨å³å¯ã€‚</div>
      </div>

      <div class="result" id="lot1-result"></div>
      <div class="small">åœ–ç‰‡ä¾†æºï¼šChristieâ€™s story pageï¼ˆè¦‹é å°¾é€£çµï¼‰ã€‚</div>
    </div>
  </article>

  <!-- Lot 2 -->
  <article class="card" data-lot="lot2">
    <div class="imgBox">
      <img
        src="https://www.christies.com/-/jssmedia/images/features/articles/2025/12/berry/74957286_dotcom-2400.jpg?mw=3200&mh=3200&hash=8a2b98b8eb7527eb747cbea1b414b5bba3b55f1d"
        alt="å” ä¸‰å½©å½©ç¹ªå¥³é¦¬çƒæ‰‹ä¿‘"
        loading="lazy">
    </div>
    <div class="content">
      <h2 class="title">æ¥µç½•è¦‹ï½œå” ä¸‰å½©å½©ç¹ªå¥³é¦¬çƒæ‰‹ä¿‘</h2>
      <p class="meta">
        <b>å”ä»£ï¼ˆ618â€“907ï¼‰</b>ï½œ13Â¾ inï¼ˆ34.6 cmï¼‰<br>
        ä¼°åƒ¹ï¼š<b>USD 80,000â€“120,000</b>ï½œChristieâ€™s New Yorkï½œ2026-03-26
      </p>
      <div class="pillRow">
        <span class="pill">å¥³é¦¬çƒæ‰‹</span>
        <span class="pill">å½©ç¹ª + ä¸‰å½©</span>
        <span class="pill">é¦¬çƒç½•è¦‹</span>
      </div>
    </div>

    <div class="voteBox">
      <p class="voteTitle">ä½ çš„é æ¸¬ï¼ˆå…ˆè¼¸å…¥å§“åå¾Œæ‰å¯æŠ•ç¥¨ï¼‰</p>

      <div class="inlineRow">
        <input class="input" id="nameInput2" type="text" placeholder="è¼¸å…¥ä½ çš„åå­—ï¼ˆä¾‹ï¼šAllen / å°æ— / Chenï¼‰" maxlength="30" oninput="saveNameFrom(2)">
      </div>

      <div class="warn" id="warn-lot2">è«‹å…ˆè¼¸å…¥åå­—ã€‚</div>
      <div class="warn" id="lock-lot2">ä½ å·²æŠ•éç¥¨ï¼ˆæœ¬æ‹å“åƒ…èƒ½æŠ•ä¸€æ¬¡ï¼‰ã€‚</div>

      <!-- åªä¿ç•™ï¼šæµæ‹ -->
      <button class="btn voteBtn" data-lot="lot2" onclick="voteBucket('lot2','æµæ‹')" disabled>æµæ‹</button>

      <!-- åªä¿ç•™ï¼šæ»‘å‹•æ¢ï¼ˆæœ€é«˜ 5,000,000ï¼‰ -->
      <div class="sliderWrap">
        <div class="sliderHead">
          <div class="sliderTitle">è‡ªå®šæˆäº¤åƒ¹ï¼ˆUSDï¼‰</div>
          <div class="sliderValue">ç›®æ¨™ï¼š<b id="sliderVal-lot2">150,000</b></div>
        </div>
        <input type="range" id="slider-lot2" min="80000" max="5000000" step="10000" value="150000" oninput="updateSlider('lot2')">
        <div class="scale">
          <span>80k</span><span>500k</span><span>2M</span><span>5M</span>
        </div>
        <button class="btn primary voteBtn" data-lot="lot2" onclick="votePrice('lot2')" disabled>æŠ•ç¥¨ï¼šä»¥ä¸Šç›®æ¨™åƒ¹æˆäº¤</button>
        <div class="hint">æç¤ºï¼šç”¨æ»‘æ¡¿èª¿æ•´ä½ çš„é æ¸¬æˆäº¤åƒ¹ï¼Œç„¶å¾ŒæŒ‰ä¸€æ¬¡æŠ•ç¥¨å³å¯ã€‚</div>
      </div>

      <div class="result" id="lot2-result"></div>
      <div class="small">åœ–ç‰‡ä¾†æºï¼šChristieâ€™s story pageï¼ˆè¦‹é å°¾é€£çµï¼‰ã€‚</div>
    </div>
  </article>

</div>

<section class="panel" id="analysisPanel">
  <h2>å³æ™‚å½¢å‹¢åˆ†æï¼ˆAI ç”Ÿæˆï½œé«˜æ•æ„Ÿï¼‰</h2>
  <div class="metaLine">
    <span class="chip"><span class="statusDot"></span><span id="analysisLive">å¯¦æ™‚æ›´æ–°ä¸­</span></span>
    <span class="chip" id="analysisStamp">æœ€è¿‘æ›´æ–°ï¼šâ€”</span>
    <span class="chip" id="heatChip">ç†±åº¦ï¼šä½ï¼ˆè¿‘ 20 ç§’ 0 ç¥¨ï¼‰</span>
  </div>
  <div class="analysisBox">
    <div class="analysisTitle">
      <span>ç¶œåˆåˆ¤è®€</span>
      <span style="font-size:12px;color:var(--muted);">èµ°å‹¢ / åè½‰ / ç†±åº¦</span>
    </div>
    <p class="analysisBody" id="analysisText">å°šæœªæœ‰è¶³å¤ æŠ•ç¥¨è³‡æ–™ã€‚è¼¸å…¥å§“åå¾ŒæŠ•ç¥¨ï¼Œç³»çµ±æœƒå³åˆ»å›é¥‹â€œæ–¹å‘/ç†±åº¦/åè½‰â€ã€‚</p>
    <div class="analysisHint">èªªæ˜ï¼šæ­¤ç‚ºå‰ç«¯è¦å‰‡åŒ–ç”Ÿæˆï¼ˆå…§æ¸¬ï¼‰ã€‚</div>
  </div>
</section>

<section class="panel" id="commentPanel">
  <h2>è©•è«–å€ï¼ˆå…è¨»å†Šï½œå³æ™‚æ›´æ–°ï¼‰</h2>
  <div class="metaLine">
    <span class="chip">ç¸½è©•è«–æ•¸ï¼š<b id="commentCount">0</b></span>
    <span class="chip">æœ€æ–°æ›´æ–°ï¼š<span id="commentStamp">â€”</span></span>
    <span class="chip">ç™¼è¨€èº«ä»½ï¼š<b id="commentWho">æœªè¨­å®šå§“å</b></span>
  </div>

  <div class="commentForm">
    <select id="commentLot">
      <option value="lot1">é‡å°ï¼šä»•å¥³ä¸€å°ï¼ˆLot 1ï¼‰</option>
      <option value="lot2">é‡å°ï¼šå¥³é¦¬çƒæ‰‹ï¼ˆLot 2ï¼‰</option>
      <option value="all">é‡å°ï¼šæ•´é«”/å°ˆå ´</option>
    </select>
    <textarea id="commentText" placeholder="å¯«ä¸‹ä½ çš„åˆ¤æ–·ï¼ˆè«‹ä¿æŒå°ˆæ¥­ã€å°±äº‹è«–äº‹ï¼‰"></textarea>
    <button class="sendBtn" onclick="submitComment()">ç™¼è¡¨</button>
  </div>

  <div class="warn" id="commentWarn">è«‹å…ˆè¼¸å…¥åå­—ï¼Œä¸”è©•è«–è‡³å°‘ 3 å€‹å­—ã€‚</div>

  <div class="commentList" id="commentList"></div>
</section>

<footer>
  æœ¬é åƒ…èšåˆæ‹å‰åˆ¤æ–·ï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°ã€‚<br>
  é æ¸¬çµæ§‹èˆ‡æ­·å²å°ç…§æ–¹æ³•ç”± <b>artsaca.com</b> ç ”ç©¶é«”ç³»æ”¯æŒã€‚<br><br>
  åœ–ç‰‡ä¾†æºé ï¼š<a class="link" href="https://www.christies.com/en/stories/max-berry-maxims-for-collecting-1f4fb6c829b340cabf5e4e2bd46f2495" target="_blank" rel="noopener">Christieâ€™sï½œMax N. Berry shares his maxims for building collections</a>
</footer>

</div>

<script>
  // ç‰¹æ¬Šåå­—ï¼šå¯é‡è¤‡æŠ•ç¥¨ï¼ˆç²¾ç¢ºåŒ¹é…ï¼‰
  const ADMIN_NAME = 'ç‹ç§‹ç”Ÿ';

  // å…§å®¹è¦ç¯„ï¼ˆå¯è‡ªè¡Œæ“´å……ï¼‰
  const BLOCKED_NAME_TOKENS = [];
  const PROFANITY_TOKENS = ['å‚»','è ¢','åƒåœ¾','å»¢ç‰©','æ»¾','å»æ­»','åª½çš„','ä»–åª½','æ“','å±Œ','å©Š','ç•œç”Ÿ'];

  function containsAnyToken(text, tokens){
    const t = (text || '').toLowerCase();
    return tokens.some(tok => tok && t.includes(tok.toLowerCase()));
  }
  function validateDisplayName(name){
    const n = (name || '').trim();
    if(!n) return { ok:false, msg:'è«‹å…ˆè¼¸å…¥åå­—ã€‚' };
    if(n.length > 30) return { ok:false, msg:'åå­—éé•·ï¼Œè«‹ç¸®çŸ­ã€‚' };
    if(containsAnyToken(n, BLOCKED_NAME_TOKENS)) return { ok:false, msg:'æ­¤å§“åä¸å¯ç”¨ï¼Œè«‹æ›´æ›ã€‚' };
    if(containsAnyToken(n, PROFANITY_TOKENS)) return { ok:false, msg:'åå­—å«ä¸ç•¶å­—è©ï¼Œè«‹æ›´æ›ã€‚' };
    return { ok:true, msg:'' };
  }
  function validateComment(text){
    const s = (text || '').trim();
    if(s.length < 3) return { ok:false, msg:'è©•è«–è‡³å°‘ 3 å€‹å­—ã€‚' };
    if(containsAnyToken(s, BLOCKED_NAME_TOKENS)) return { ok:false, msg:'è©•è«–åŒ…å«ä¸å…è¨±çš„äººå/ç¨±è¬‚ï¼Œè«‹ä¿®æ”¹ã€‚' };
    if(containsAnyToken(s, PROFANITY_TOKENS)) return { ok:false, msg:'è©•è«–åŒ…å«ä¸ç•¶è¨€è©ï¼Œè«‹ä¿æŒå°ˆæ¥­ã€‚' };
    return { ok:true, msg:'' };
  }

  // çµ±è¨ˆï¼šæµæ‹ + åƒ¹æ ¼ï¼ˆåƒ¹æ ¼æŠ•ç¥¨æ¡ã€ŒåŠ æ¬Šåˆ†ä½ˆã€å±•ç¤ºï¼‰
  const state = {
    lot1:{ unsold:0, priceVotes:[] },
    lot2:{ unsold:0, priceVotes:[] }
  };

  // èµ°å‹¢ï¼šå…±è­˜åƒ¹æ ¼ï¼ˆä¸­ä½æ•¸ï¼‰+ æµæ‹æ¯”ä¾‹
  const series = { lot1: [], lot2: [] };

  // æŠ•ç¥¨æ­·å²ï¼ˆæ’¤å›ç”¨ï¼‰
  const history = { lot1: [], lot2: [] };


  /* =========================
     Cloudflare Pages API (KV-backed)
     ========================= */
  const API = { state: "/state", vote: "/vote", comment: "/comment" };
  window.__serverComments = [];

  async function apiGetState(){
    const r = await fetch(API.state, { cache: "no-store" });
    return r.json();
  }
  async function apiVote(payload){
    const r = await fetch(API.vote, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify(payload),
    });
    return r.json();
  }
  async function apiComment(payload){
    const r = await fetch(API.comment, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify(payload),
    });
    return r.json();
  }

  function applyServerState(serverState){
    try{
      if(!serverState || !serverState.lots) return;

      // Sync lots
      state.lot1.unsold = Number(serverState.lots.lot1?.unsold || 0);
      state.lot1.priceVotes = Array.isArray(serverState.lots.lot1?.prices) ? serverState.lots.lot1.prices : [];
      series.lot1 = Array.isArray(serverState.lots.lot1?.series) ? serverState.lots.lot1.series : [];

      state.lot2.unsold = Number(serverState.lots.lot2?.unsold || 0);
      state.lot2.priceVotes = Array.isArray(serverState.lots.lot2?.prices) ? serverState.lots.lot2.prices : [];
      series.lot2 = Array.isArray(serverState.lots.lot2?.series) ? serverState.lots.lot2.series : [];

      // Sync comments
      window.__serverComments = Array.isArray(serverState.comments) ? serverState.comments : [];

      // Render
      render("lot1");
      render("lot2");
      renderCommentsFromServer();
    }catch(e){
      console.error("applyServerState error:", e);
    }
  }

  async function syncLoop(){
    try{
      const j = await apiGetState();
      if(j && j.ok) applyServerState(j.state);
    }catch(e){
      console.error("syncLoop error:", e);
    }
  }

  // Name gating
  const NAME_KEY = 'hs_name_v7';
  function getName(){ return (localStorage.getItem(NAME_KEY) || '').trim(); }
  function syncNameInputs(v){
    const a = document.getElementById('nameInput');
    const b = document.getElementById('nameInput2');
    if(a && a.value !== v) a.value = v;
    if(b && b.value !== v) b.value = v;
  }
  function setNameUI(name){
    document.getElementById('whoAmI').textContent = name ? name : 'æœªè¨­å®šå§“å';
    document.getElementById('commentWho').textContent = name ? name : 'æœªè¨­å®šå§“å';

    // ä¸é¡¯ç¤ºâ€œç®¡ç†å“¡å¯é‡è¤‡æŠ•ç¥¨â€ç­‰å­—æ¨£ï¼ˆæŒ‰ä½ çš„è¦æ±‚ï¼‰
    const btns = document.querySelectorAll('.voteBtn');
    btns.forEach(b => b.disabled = !name);

    refreshVoteLocks();
    updateAnalysis({ trigger:'idle' });

  // å•Ÿå‹•å¤šäººåŒæ­¥ï¼ˆæ¯ 2 ç§’æ‹‰å–ä¸€æ¬¡ï¼‰
  setInterval(syncLoop, 2000);
  syncLoop();
  
  // Auction notes
  const __nb = document.getElementById('notesRefreshBtn');
  if(__nb) __nb.addEventListener('click', loadAuctionNotes);
  loadAuctionNotes();
  setInterval(loadAuctionNotes, 10*60*1000);
}
  function saveNameFrom(which){
    const el = which===2 ? document.getElementById('nameInput2') : document.getElementById('nameInput');
    const v = (el.value || '').trim().slice(0,30);
    const vr = validateDisplayName(v);
    if(!vr.ok){
      localStorage.setItem(NAME_KEY, '');
      syncNameInputs(v);
      setNameUI('');
      const cw = document.getElementById('commentWarn');
      cw.textContent = vr.msg;
      cw.style.display = 'block';
      return;
    }
    localStorage.setItem(NAME_KEY, v);
    syncNameInputs(v);
    const cw = document.getElementById('commentWarn');
    cw.style.display = 'none';
    cw.textContent = 'è«‹å…ˆè¼¸å…¥åå­—ï¼Œä¸”è©•è«–è‡³å°‘ 3 å€‹å­—ã€‚';
    setNameUI(v);
  }
  (function initName(){
    const v = getName();
    syncNameInputs(v);
    setNameUI(v);
  })();

  // Device lockï¼ˆæ¯ç«¯ä¸€ç¥¨/æ¯æ‹å“ï¼‰
  function cryptoRandomId(){
    try{
      const arr = new Uint8Array(3);
      crypto.getRandomValues(arr);
      return Array.from(arr).map(b=>b.toString(16).padStart(2,'0')).join('');
    }catch(e){
      return Math.random().toString(16).slice(2,8);
    }
  }
  function deviceKey(){
    const k = 'hs_device_id_v1';
    let id = localStorage.getItem(k);
    if(!id){
      id = cryptoRandomId() + cryptoRandomId() + cryptoRandomId();
      localStorage.setItem(k, id);
    }
    return id;
  }
  function lockKey(lot){ return `hs_vote_lock_${deviceKey()}_${lot}_v2`; }
  function hasVoted(lot){ return localStorage.getItem(lockKey(lot)) === '1'; }
  function setVoted(lot){ localStorage.setItem(lockKey(lot), '1'); }
  function clearVoted(lot){ localStorage.removeItem(lockKey(lot)); }
  function showLock(lot, on){
    const el = document.getElementById('lock-' + lot);
    if(el) el.style.display = on ? 'block' : 'none';
  }
  function setLotButtonsEnabled(lot, enabled){
    document.querySelectorAll(`.voteBtn[data-lot="${lot}"]`).forEach(btn=>{
      btn.disabled = !enabled;
    });
  }
  function refreshVoteLocks(){
    const name = getName();
    if(!name) return;
    const isAdmin = (name === ADMIN_NAME);

    if(isAdmin){
      showLock('lot1', false); showLock('lot2', false);
      setLotButtonsEnabled('lot1', true); setLotButtonsEnabled('lot2', true);
      return;
    }
    const l1 = hasVoted('lot1');
    const l2 = hasVoted('lot2');
    showLock('lot1', l1); showLock('lot2', l2);
    setLotButtonsEnabled('lot1', !l1);
    setLotButtonsEnabled('lot2', !l2);
  }

  // Slider display
  function updateSlider(lot){
    const el = document.getElementById(`slider-${lot}`);
    const out = document.getElementById(`sliderVal-${lot}`);
    if(!el || !out) return;
    out.textContent = Number(el.value).toLocaleString('en-US');
  }
  updateSlider('lot1'); updateSlider('lot2');

  // Predictions store (for later "closest winner")
  const PRED_KEY = 'hs_predictions_v7';
  function loadPreds(){ try{ return JSON.parse(localStorage.getItem(PRED_KEY) || '[]'); }catch(e){ return []; } }
  function savePreds(list){ localStorage.setItem(PRED_KEY, JSON.stringify(list)); }

  function showWarn(lot, on){
    const el = document.getElementById('warn-' + lot);
    if(el) el.style.display = on ? 'block' : 'none';
  }

  // Heat
  const voteTimestamps = [];
  function recordHeat(){
    const now = Date.now();
    voteTimestamps.push(now);
    const windowMs = 20000;
    while(voteTimestamps.length && (now - voteTimestamps[0]) > windowMs) voteTimestamps.shift();
    const c = voteTimestamps.length;

    let label = 'ä½';
    if(c >= 18) label = 'çˆ†';
    else if(c >= 12) label = 'é«˜';
    else if(c >= 6) label = 'ä¸­';

    document.getElementById('heatChip').textContent = `ç†±åº¦ï¼š${label}ï¼ˆè¿‘ 20 ç§’ ${c} ç¥¨ï¼‰`;
  }

  // Vote: Unsold (server-backed)
  async function voteBucket(lot, bucket){
    const name = getName();
    const vr = validateDisplayName(name);
    if(!vr.ok){ showWarn(lot, true); return; }

    showWarn(lot, false);

    const res = await apiVote({ lot, type:"UNSOLD", price:null, name });

    if(!res || !res.ok){
      if(res && res.error === "ALREADY_VOTED"){
        showLock(lot, true);
        refreshVoteLocks();
        return;
      }
      alert("æŠ•ç¥¨å¤±æ•—ï¼š" + (res && res.error ? res.error : "æœªçŸ¥éŒ¯èª¤"));
      return;
    }

    applyServerState(res.state);
    recordHeat();
    updateAnalysis({ trigger:'vote_unsold', lot });
    refreshVoteLocks();

    // ä¿éšªï¼šå†æ‹‰ä¸€æ¬¡æœ€æ–°ç‹€æ…‹ï¼ˆé¿å…å¶ç™¼å»¶é²ï¼‰
    syncLoop();
  }


  // Vote: Price (slider) (server-backed)
  async function votePrice(lot){
    const name = getName();
    const vr = validateDisplayName(name);
    if(!vr.ok){ showWarn(lot, true); return; }

    const slider = document.getElementById(`slider-${lot}`);
    const price = slider ? Number(slider.value) : null;
    if(!price){ showWarn(lot, true); return; }

    showWarn(lot, false);

    const res = await apiVote({ lot, type:"PRICE", price, name });

    if(!res || !res.ok){
      if(res && res.error === "ALREADY_VOTED"){
        showLock(lot, true);
        refreshVoteLocks();
        return;
      }
      alert("æŠ•ç¥¨å¤±æ•—ï¼š" + (res && res.error ? res.error : "æœªçŸ¥éŒ¯èª¤"));
      return;
    }

    applyServerState(res.state);
    recordHeat();
    updateAnalysis({ trigger:'vote_price', lot, price });
    refreshVoteLocks();

    syncLoop();
  }


  // Chart series point = median price (or 0 if none), plus unsold share
  function median(arr){
    if(!arr || !arr.length) return null;
    const a = [...arr].sort((x,y)=>x-y);
    const mid = Math.floor(a.length/2);
    return (a.length%2) ? a[mid] : (a[mid-1]+a[mid])/2;
  }

  function render(lot){
    const el = document.getElementById(lot + '-result');
    if(!el) return;

    const uns = state[lot].unsold;
    const pv = state[lot].priceVotes;
    const total = uns + pv.length;

    const m = median(pv);
    const unsPct = total ? (uns/total*100) : 0;

    // Update series: use a "consensus metric" 0-100 for chart = (1 - unsPct) * normalized-median? -> instead show two charts? keep one: unsold% trend
    // To keep Polymarket feel: we plot "æˆäº¤å¯èƒ½æ€§" = 100 - æµæ‹æ¯”ä¾‹
    const settleProb = total ? (100 - unsPct) : 0;
    // èµ°å‹¢ï¼šå„ªå…ˆä½¿ç”¨å¾Œç«¯å›å‚³çš„ seriesï¼›è‹¥å¾Œç«¯ä»ç‚ºç©ºï¼Œå‰ç«¯æš«æ™‚è£œä¸€å€‹é»ç¶­æŒå³æ™‚é«”æ„Ÿ
    if(!Array.isArray(series[lot])) series[lot] = [];
    if(series[lot].length === 0){
      series[lot].push({ ts: Date.now(), v: settleProb });
    }

    el.style.display = 'block';

    const canvasId = `${lot}-chart`;
    const tipId = `${lot}-tip`;
    const crossId = `${lot}-cross`;

    const priceText = (m===null) ? 'â€”' : `${Math.round(m).toLocaleString('en-US')} USD`;
    const probText = total ? `${settleProb.toFixed(1)}%` : 'â€”';

    el.innerHTML = `
      <div><b>ç›¤é¢æŒ‡æ¨™ï¼š</b>æˆäº¤å¯èƒ½æ€§ ${probText} ï½œ æµæ‹æ¯”ä¾‹ ${unsPct.toFixed(1)}% ï½œ åƒ¹æ ¼ä¸­ä½æ•¸ ${priceText}</div>
      <div class="bar"><div style="width:${Math.max(0, Math.min(100, settleProb))}%"></div></div>
      <div class="rows">
        <div class="row"><div>æµæ‹</div><div><b>${unsPct.toFixed(1)}%</b>ï¼ˆ${uns}ï¼‰</div></div>
        <div class="row"><div>åƒ¹æ ¼æŠ•ç¥¨</div><div><b>${total ? (pv.length/total*100).toFixed(1) : '0.0'}%</b>ï¼ˆ${pv.length}ï¼‰</div></div>
      </div>

      <!-- Latest Auction Notes (artsaca.com) -->
      <div class="card" id="notesBox">
        <div class="row" style="align-items:center; justify-content:space-between;">
          <div>
            <div class="h2">artsaca.com æœ€æ–° 10 ç¯‡æ‹è³£ç­†è¨˜</div>
            <div class="muted" style="margin-top:4px;">è‡ªå‹•æŠ“å–åˆ†é¡é ï¼š/artsaca/categories/auctionnotes</div>
          </div>
          <button class="btn ghost" id="notesRefreshBtn" type="button">åˆ·æ–°</button>
        </div>
        <div class="muted" id="notesWarn" style="margin-top:10px; display:none;"></div>
        <div style="margin-top:10px;">
          <ol id="notesList" style="margin:0; padding-left:18px;"></ol>
        </div>
      </div>



      <div class="chartWrap" id="${lot}-chartWrap">
        <div class="chartHead">
          <div class="chartTitle">ğŸ“ˆ èµ°å‹¢ï¼ˆæˆäº¤å¯èƒ½æ€§ï¼Œæ»‘é¼ å›çœ‹ï¼‰</div>
          <div class="sparkLabel">æœ€æ–°ï¼š${total ? settleProb.toFixed(1) : '0.0'}%</div>
        </div>
        <div class="tooltip" id="${tipId}"></div>
        <div class="crosshair" id="${crossId}"></div>
        <canvas id="${canvasId}" width="900" height="240"></canvas>
      </div>
    `;

    drawLineChart(canvasId, series[lot]);
    attachHoverScrub(lot);

    // Update â€œAIâ€ response moreæ•æ„Ÿ
    updateAnalysis({ trigger:'render', lot, settleProb, unsPct, median:m });
  }

  function drawLineChart(canvasId, data){
    const canvas = document.getElementById(canvasId);
    if(!canvas) return;
    const ctx = canvas.getContext('2d');

    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0,0,W,H);

    const padL=42, padR=12, padT=14, padB=26;
    const x0=padL, y0=padT, x1=W-padR, y1=H-padB;

    ctx.fillStyle = '#fff';
    ctx.fillRect(0,0,W,H);

    ctx.strokeStyle = '#e8e8e8';
    ctx.lineWidth = 1;
    const levels=[0,25,50,75,100];
    levels.forEach(v=>{
      const y = y1 - (v/100)*(y1-y0);
      ctx.beginPath(); ctx.moveTo(x0,y); ctx.lineTo(x1,y); ctx.stroke();
      ctx.fillStyle = '#777';
      ctx.font = '12px -apple-system,BlinkMacSystemFont,"PingFang TC",sans-serif';
      ctx.fillText(`${v}%`, 8, y+4);
    });

    if(!data || data.length < 2){
      ctx.fillStyle='#666';
      ctx.font='12px -apple-system,BlinkMacSystemFont,"PingFang TC",sans-serif';
      ctx.fillText('éœ€è¦æ›´å¤šæŠ•ç¥¨æ‰æœƒå½¢æˆèµ°å‹¢', x0, y0+14);
      if(data && data.length===1){
        const py = y1 - (data[0].v/100)*(y1-y0);
        ctx.fillStyle='#111';
        ctx.beginPath(); ctx.arc(x0, py, 3.5, 0, Math.PI*2); ctx.fill();
      }
      return;
    }

    const n=data.length;
    const xStep=(x1-x0)/(n-1);

    ctx.strokeStyle='#111';
    ctx.lineWidth=2;
    ctx.beginPath();
    data.forEach((p,i)=>{
      const x=x0+i*xStep;
      const y=y1-(p.v/100)*(y1-y0);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();

    const last=data[n-1];
    const lx=x0+(n-1)*xStep;
    const ly=y1-(last.v/100)*(y1-y0);
    ctx.fillStyle='#111';
    ctx.beginPath(); ctx.arc(lx, ly, 4, 0, Math.PI*2); ctx.fill();
  }

  function attachHoverScrub(lot){
    const wrap = document.getElementById(`${lot}-chartWrap`);
    const canvas = document.getElementById(`${lot}-chart`);
    const tip = document.getElementById(`${lot}-tip`);
    const cross = document.getElementById(`${lot}-cross`);
    if(!wrap || !canvas || !tip || !cross) return;

    const data = series[lot] || [];
    if(data.length < 2) return;

    const padL=42, padR=12;
    const W = canvas.width;
    const x0 = padL, x1 = W - padR;

    function showAt(clientX){
      const rect = canvas.getBoundingClientRect();
      const px = (clientX - rect.left) * (canvas.width / rect.width);
      const clamped = Math.max(x0, Math.min(x1, px));
      const t = (clamped - x0) / (x1 - x0);
      const idx = Math.round(t * (data.length - 1));
      const p = data[idx];
      if(!p) return;

      const wrapRect = wrap.getBoundingClientRect();
      const crossX = (clamped / canvas.width) * rect.width;
      cross.style.display = 'block';
      cross.style.left = `${rect.left - wrapRect.left + crossX}px`;

      tip.style.display = 'block';
      tip.textContent = `${formatTime(p.ts)}ï½œæˆäº¤å¯èƒ½æ€§ ${p.v.toFixed(1)}%`;
      tip.style.left = `${rect.left - wrapRect.left + crossX}px`;
      tip.style.top = `44px`;

      updateAnalysis({ trigger:'scrub', lot, snapshot:p, idx });
    }

    canvas.onmousemove = (e)=>showAt(e.clientX);
    canvas.onmouseenter = (e)=>showAt(e.clientX);
    canvas.onmouseleave = ()=>{
      tip.style.display='none';
      cross.style.display='none';
      updateAnalysis({ trigger:'idle' });

  // å•Ÿå‹•å¤šäººåŒæ­¥ï¼ˆæ¯ 2 ç§’æ‹‰å–ä¸€æ¬¡ï¼‰
  setInterval(syncLoop, 2000);
  syncLoop();
    };
  }

  // Countdown
  const auctionUTC = Date.parse('2026-03-26T14:00:00Z');
  function tick(){
    const now=Date.now();
    let diff=auctionUTC-now;
    const el=document.getElementById('countdown');
    if(!el) return;

    if(diff<=0){
      el.textContent='æ‹è³£å€’æ•¸ï¼šå·²åˆ°æ‹è³£æ—¥ï¼ˆç­‰å¾…çµæœå…¬å¸ƒï¼‰';
      return;
    }
    const d=Math.floor(diff/86400000); diff-=d*86400000;
    const h=Math.floor(diff/3600000);  diff-=h*3600000;
    const m=Math.floor(diff/60000);    diff-=m*60000;
    const s=Math.floor(diff/1000);
    const pad=(n)=>String(n).padStart(2,'0');
    el.textContent=`æ‹è³£å€’æ•¸ï¼š${d} å¤© ${pad(h)}:${pad(m)}:${pad(s)}`;
  }
  tick();
  setInterval(tick, 250);

  // Comments
  const COMMENTS_KEY = 'hs_comments_v7';
  const COMMENTS_PING = 'hs_comments_ping_v7';

  function loadComments(){
    try{ const raw = localStorage.getItem(COMMENTS_KEY); return raw ? JSON.parse(raw) : []; }
    catch(e){ return []; }
  }
  function saveComments(list){
    localStorage.setItem(COMMENTS_KEY, JSON.stringify(list));
    localStorage.setItem(COMMENTS_PING, String(Date.now()));
  }
  function sanitizeText(s){
    return (s || '').replace(/[\u0000-\u001F\u007F]/g, '').trim().slice(0, 800);
  }
  function lotLabel(lot){
    if(lot==='lot1') return 'ä»•å¥³ä¸€å°';
    if(lot==='lot2') return 'å¥³é¦¬çƒæ‰‹';
    return 'æ•´é«”/å°ˆå ´';
  }
  function formatTime(ts){
    const d = new Date(ts);
    const pad=(n)=>String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }
  function escapeHtml(s){
    return (s||'')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#39;");
  }

  async function submitComment(){
    const name = getName();
    const vr = validateDisplayName(name);
    const lot = document.getElementById('commentLot').value;
    const text = sanitizeText(document.getElementById('commentText').value);
    const warn = document.getElementById('commentWarn');

    if(!vr.ok){
      warn.textContent = vr.msg;
      warn.style.display='block';
      return;
    }
    const cr = validateComment(text);
    if(!cr.ok){
      warn.textContent = cr.msg;
      warn.style.display='block';
      return;
    }

    warn.style.display='none';
    warn.textContent = 'è«‹å…ˆè¼¸å…¥åå­—ï¼Œä¸”è©•è«–è‡³å°‘ 3 å€‹å­—ã€‚';

    const res = await apiComment({ lot, name, text });
    if(!res || !res.ok){
      alert("è©•è«–å¤±æ•—ï¼š" + (res && res.error ? res.error : "æœªçŸ¥éŒ¯èª¤"));
      return;
    }

    document.getElementById('commentText').value = '';
    applyServerState(res.state);

    // ä¿éšªå†åŒæ­¥ä¸€æ¬¡
    syncLoop();
  }

  function renderCommentsFromServer(){
    const list = window.__serverComments || [];
    document.getElementById('commentCount').textContent = String(list.length);
    document.getElementById('commentStamp').textContent = list.length ? formatTime(list[list.length-1].ts) : 'â€”';

    const items = [...list].sort((a,b)=>b.ts - a.ts).slice(0, 80);
    const container = document.getElementById('commentList');

    container.innerHTML = items.map(item => `
      <div class="comment">
        <div class="commentHead">
          <div><b>${escapeHtml(item.name)}</b>ï½œ<b>${lotLabel(item.lot)}</b>ï½œ${formatTime(item.ts)}</div>
          <div style="color:#999;">#${item.id}</div>
        </div>
        <p class="commentBody">${escapeHtml(item.text)}</p>
      </div>
    `).join('') || `<div class="comment"><div class="commentHead"><b>å°šç„¡è©•è«–</b></div><p class="commentBody">è¼¸å…¥å§“åå¾Œå³å¯ç›´æ¥ç™¼è¡¨ã€‚</p></div>`;
  }

  // æœ¬åœ° storage åŒæ­¥åœç”¨ï¼šå¤šäººæ¨¡å¼ä»¥ /state ç‚ºæº–

  // â€œAIâ€ analysisï¼šé«˜æ•æ„Ÿã€æ¯æ¬¡æŠ•ç¥¨å³åˆ»åæ‡‰ï¼ˆä¸åšä»»ä½•â€œæ–·ç·šâ€æ¼”ç¤ºï¼‰
  function updateAnalysis(ctx = {}){
    const now = Date.now();
    document.getElementById('analysisStamp').textContent = `æœ€è¿‘æ›´æ–°ï¼š${formatTime(now)}`;

    const heatText = document.getElementById('heatChip').textContent || '';
    const heatLevel = heatText.includes('çˆ†') ? 'çˆ†' : heatText.includes('é«˜') ? 'é«˜' : heatText.includes('ä¸­') ? 'ä¸­' : 'ä½';

    const lines = [];
    if(ctx.trigger === 'vote_price'){
      const lotName = ctx.lot==='lot1' ? 'Lot 1ï¼ˆä»•å¥³ä¸€å°ï¼‰' : 'Lot 2ï¼ˆå¥³é¦¬çƒæ‰‹ï¼‰';
      lines.push(`ã€å³æ™‚åæ‡‰ã€‘${lotName} å‡ºç¾åƒ¹æ ¼æŠ•ç¥¨ï¼š${Number(ctx.price).toLocaleString('en-US')} USDã€‚`);
      if(heatLevel==='é«˜' || heatLevel==='çˆ†') lines.push(`ã€ç†±åº¦ã€‘çŸ­æ™‚é–“æŠ•ç¥¨å¯†é›†ï¼Œæ•˜äº‹æ˜“è¢«å¿«é€ŸéŒ¨å®šï¼›ç•™æ„èµ°å‹¢æ˜¯å¦å‡ºç¾å–®é‚ŠåŠ é€Ÿã€‚`);
      else lines.push(`ã€ç¯€å¥ã€‘ç›®å‰ç†±åº¦ ${heatLevel}ï¼Œæ›´åƒâ€œç†æ€§èšåˆâ€è€Œéæƒ…ç·’æ“æ“ ã€‚`);
    } else if(ctx.trigger === 'vote_unsold'){
      const lotName = ctx.lot==='lot1' ? 'Lot 1ï¼ˆä»•å¥³ä¸€å°ï¼‰' : 'Lot 2ï¼ˆå¥³é¦¬çƒæ‰‹ï¼‰';
      lines.push(`ã€å³æ™‚åæ‡‰ã€‘${lotName} å‡ºç¾æµæ‹æŠ•ç¥¨ã€‚`);
      if(heatLevel==='é«˜' || heatLevel==='çˆ†') lines.push(`ã€ç†±åº¦ã€‘åœ¨é«˜ç†±åº¦ä¸‹å‡ºç¾â€œæµæ‹â€è¨Šè™Ÿï¼Œé€šå¸¸ä»£è¡¨åˆ†æ­§æ“´å¤§ï¼›é—œæ³¨æ¥ä¸‹ä¾†æ˜¯å¦è¿…é€Ÿè¢«åå‘æŠ•ç¥¨ä¿®æ­£ã€‚`);
      else lines.push(`ã€çµæ§‹ã€‘ä½ç†±åº¦ä¸‹çš„â€œæµæ‹â€æ›´å¤šæ˜¯ä¿å®ˆé æœŸï¼Œéœ€ç­‰å¾…æ›´å¤šæ¨£æœ¬ã€‚`);
    } else if(ctx.trigger === 'scrub' && ctx.snapshot){
      lines.push(`ã€å›çœ‹ã€‘${formatTime(ctx.snapshot.ts)}ï½œæˆäº¤å¯èƒ½æ€§ ${ctx.snapshot.v.toFixed(1)}%`);
      lines.push(`ã€ç”¨æ³•ã€‘ç”¨ä¾†åˆ¤æ–·â€œå…±è­˜å½¢æˆé€Ÿåº¦â€èˆ‡â€œåè½‰æˆæœ¬â€ã€‚`);
    } else {
      lines.push(`ã€ç‹€æ…‹ã€‘è¼¸å…¥å§“åå¾ŒæŠ•ç¥¨ï¼Œç³»çµ±æœƒå³åˆ»å›é¥‹â€œæ–¹å‘/ç†±åº¦/åè½‰â€ã€‚`);
      lines.push(`ã€ç†±åº¦ã€‘${document.getElementById('heatChip').textContent}`);
    }

    document.getElementById('analysisText').textContent = lines.join('\n');
  }



  /* =========================
     Latest Auction Notes (artsaca.com)
     Backend endpoint: GET /notes?limit=10
     ========================= */
  function shortenTitle(t, maxLen=120){
    const s = (t || "").trim();
    return s.length > maxLen ? (s.slice(0, maxLen-1) + "â€¦") : s;
  }

  async function loadAuctionNotes(){
    const warn = document.getElementById("notesWarn");
    const list = document.getElementById("notesList");
    if(!warn || !list) return;

    warn.style.display = "none";
    warn.textContent = "";
    list.innerHTML = "";

    try{
      const r = await fetch(`/notes?limit=10&ts=${Date.now()}`, { cache: "no-store" });
      const j = await r.json();

      if(!j || !j.ok){
        warn.textContent = "æŠ“å–å¤±æ•—ï¼š" + (j && j.error ? j.error : "æœªçŸ¥éŒ¯èª¤");
        warn.style.display = "block";
        return;
      }

      const items = Array.isArray(j.items) ? j.items : [];
      if(items.length === 0){
        warn.textContent = "å·²é€£ç·šï¼Œä½†æœªå–å¾—æ–‡ç« åˆ—è¡¨ï¼ˆitems ç‚ºç©ºï¼‰ã€‚";
        warn.style.display = "block";
        return;
      }

      list.innerHTML = items.map(it => {
        const title = shortenTitle(it.title || "");
        const url = it.url || "#";
        return `<li style="margin:8px 0;"><a href="${url}" target="_blank" rel="noopener">${escapeHtml(title)}</a></li>`;
      }).join("");

    }catch(e){
      warn.textContent = "æŠ“å–å¤±æ•—ï¼ˆå¯èƒ½æ˜¯ /notes å°šæœªéƒ¨ç½²æˆ–å›å‚³é JSONï¼‰ã€‚";
      warn.style.display = "block";
      console.error("loadAuctionNotes error:", e);
    }
  }

  // åˆå§‹åŒ–
  render('lot1');
  render('lot2');
  renderCommentsFromServer();
  refreshVoteLocks();
  updateSlider('lot1');
  updateSlider('lot2');
  updateAnalysis({ trigger:'idle' });

  // å•Ÿå‹•å¤šäººåŒæ­¥ï¼ˆæ¯ 2 ç§’æ‹‰å–ä¸€æ¬¡ï¼‰
  setInterval(syncLoop, 2000);
  syncLoop();
</script>

</body>
</html>
